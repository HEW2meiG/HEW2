{% from "_formhelpers.html" import render_field %}
{% extends "base.html" %}
{%block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/message.css')}}">
{% endblock%}
{% block title %}
取引画面 - {{ super() }}
{% endblock %}
{% block content %}
{% for message in get_flashed_messages() %}
    {{ message }}
{% endfor %}
<h2>取引画面</h2>
<h3>取引情報</h3>
<table>
    <tr>
        <th>商品</th>
        <td><a href="{{url_for('item.itemdata', item_id=item.Sell_id)}}">
            {{ item.key1 }}
            {{ item.key2 }}
            {{ item.key3 }}
            {{ item.price }}
            {{ item.sell_comment }}
        </a></td>
    </tr>
    <tr>
        <th>送料</th>
        <td>{{ item.postage.name }}</td>
    </tr>
    <tr>
        <th>購入日時</th>
        <td>{{ buy.create_at.strftime("%Y/%m/%d %H:%M") }}</td>
    </tr>
    <tr>
        <th>商品ID</th>
        <td>{{ item.Sell_id }}</td>
    </tr>
    <tr>
        <th>お届け先</th>
        <td>
            <p>
                {{ shippingaddress.zip_code }}<br>
                {{ shippingaddress.prefecture }}
                {{ shippingaddress.address1 }}
                {{ shippingaddress.address2 }}<br>
                {{ shippingaddress.address3 }}
            </p>
            <p>
                {{ shippingaddress.last_name }}
                {{ shippingaddress.first_name }}
                様
            </p>
        </td>
    </tr>
</table>
<h3>出品者情報</h3>
<img src="{{url_for('static', filename='user_image/' + item.user.picture_path)}}">
{{ item.user.username }}
<h3>取引メッセージ</h3>
{% for message in messages %}
    {% if message.from_user_id == current_user.User_id %}
        <!-- 自分側 -->
        <div class="msg-box">
            <div class="speech-bubble-self">
                <!-- 改行部分を区切ってforループする -->
                {% for splitted_message in message.message|replace_newline %}
                    <p>{{ splitted_message|urlize }}</p>
                {% endfor %}
            </div>
            <div class="msger-wrap">
                <img src="{{url_for('static', filename='user_image/' + current_user.picture_path)}}">
                <p>{{ current_user.username }}</p>
            </div>
        </div>
    {% else %}
        <!-- 相手側 -->
        <div class="msg-box">
            <div class="msger-wrap">
                <img src="{{url_for('static', filename='user_image/' + dest_user.picture_path)}}">
                <p>{{ dest_user.username }}</p>
            </div>
            <div class="speech-bubble-dest">
                <!-- 改行部分を区切ってforループする -->
                {% for splitted_message in message.message|replace_newline %}
                    <p>{{ splitted_message|urlize }}</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endfor %}
<form method="POST">
    {{ messageform.csrf_token }}
    {{ render_field(messageform.message, cols="50", rows="5") }}
    {{ messageform.submit() }}
</form>
{% endblock %}